---
id: basics
title: Basics
sidebar_label: Basics
description: basics
keywords:
  - basics
---

## Installation

```shell
go get -u github.com/gin-gonic/gin
```

## Logger(zap)

```go title="internal/logger/logger.go"
package logger

import (
	"net"
	"net/http"
	"net/http/httputil"
	"os"
	"runtime/debug"
	"strings"
	"time"

	"github.com/HITS-AI/oneplatform-auth/internal/config"
	"github.com/gin-gonic/gin"
	"go.uber.org/zap"
	"go.uber.org/zap/zapcore"
)

func Init() {
	var l *zap.Logger
	c := config.Config()
	if c.Debug {
		l, _ = zap.NewDevelopment()
	} else {
		l, _ = zap.NewProduction()
	}
	defer l.Sync()
	zap.ReplaceGlobals(l)
}

func Ginzap(skipPaths []string) gin.HandlerFunc {
	skip := make(map[string]bool, len(skipPaths))
	for _, path := range skipPaths {
		skip[path] = true
	}

	return func(c *gin.Context) {
		start := time.Now()
		// 일부 미들웨어는 이 값을 변경합니다.
		path := c.Request.URL.Path

		// 다음 미들웨어를 실행합니다.
		c.Next()
		// 미들웨어들이 실행 된 후 로깅이 실행됩니다.

		if _, ok := skip[path]; !ok {
			end := time.Now()
			latency := end.Sub(start)

			if len(c.Errors) > 0 {
				// Append error field if this is an erroneous request.
				for _, e := range c.Errors {
					fields := []zapcore.Field{
						zap.String("method", c.Request.Method),
						zap.String("url", path),
						zap.Int("status", c.Writer.Status()),
						zap.String("remoteAddress", c.ClientIP()),
						zap.String("userAgent", c.Request.UserAgent()),
						zap.Error(e),
						zap.Duration("latency", latency),
					}
					zap.L().Info(path, fields...)
				}
			} else {
				fields := []zapcore.Field{
					zap.String("method", c.Request.Method),
					zap.String("url", path),
					zap.Int("status", c.Writer.Status()),
					zap.String("remoteAddress", c.ClientIP()),
					zap.String("userAgent", c.Request.UserAgent()),
					zap.Duration("latency", latency),
				}
				zap.L().Info(path, fields...)
			}
		}
	}
}

func RecoveryWithZap(stack bool) gin.HandlerFunc {
	return func(c *gin.Context) {
		defer func() {
			if err := recover(); err != nil {
				// Check for a broken connection, as it is not really a
				// condition that warrants a panic stack trace.
				var brokenPipe bool
				if ne, ok := err.(*net.OpError); ok {
					if se, ok := ne.Err.(*os.SyscallError); ok {
						if strings.Contains(strings.ToLower(se.Error()), "broken pipe") || strings.Contains(strings.ToLower(se.Error()), "connection reset by peer") {
							brokenPipe = true
						}
					}
				}

				httpRequest, _ := httputil.DumpRequest(c.Request, false)
				if brokenPipe {
					zap.L().Error(c.Request.URL.Path,
						zap.Any("error", err),
						zap.String("request", string(httpRequest)),
					)
					// If the connection is dead, we can't write a status to it.
					c.Error(err.(error)) // nolint: errcheck
					c.Abort()
					return
				}

				if stack {
					zap.L().Error("[Recovery from panic]",
						zap.Time("time", time.Now()),
						zap.Any("error", err),
						zap.String("request", string(httpRequest)),
						zap.String("stack", string(debug.Stack())),
					)
				} else {
					zap.L().Error("[Recovery from panic]",
						zap.Time("time", time.Now()),
						zap.Any("error", err),
						zap.String("request", string(httpRequest)),
					)
				}
				c.AbortWithStatus(http.StatusInternalServerError)
			}
		}()
		c.Next()
		// 사이에 실행된 미들웨어에서 panic이 발생한 경우 recovery 됩니다.
	}
}
```

```go title="main.go"
	config.Init()

	logger.Init()

	// 미들웨어 선언 순서는 아래와 같아야 합니다.
	// 다른 미들웨어는 RecoveryWithZap 이후에 실행해 주세요.
	r := gin.New()
	r.Use(logger.Ginzap([]string{}))
	r.Use(logger.RecoveryWithZap(true))
```

## Reference

- [https://github.com/gin-gonic/gin](https://github.com/gin-gonic/gin)
