---
id: keycloak
title: keycloak
sidebar_label: keycloak
description: keycloak
keywords:
  - keycloak
---

## Installation

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: <secret-name>
  namespace: auth
type: Opaque
stringData:
  admin-password: <password>
  management-password: <password>
  db-password: <password>
```

```shell
helm repo add bitnami https://charts.bitnami.com/bitnami \
&& helm repo update bitnami
```

```shell
helm search repo bitnami/keycloak -l | head -n 10
```

```shell
mkdir -p atuh/keycloak/helm
```

```shell
helm show values bitnami/keycloak \
    --version 7.1.17 \
    > atuh/keycloak/helm/values.yaml
```

```yaml title="atuh/keycloak/helm/values.yaml"
auth:
  createAdminUser: true # 설치 성공 후, admin 역할의 유저를 생성하고, 이 값을 false로 해주세요.
  adminUser: <user>
  managementUser: <user>
  existingSecret: <secret-name>

proxyAddressForwarding: true

service:
  type: ClusterIP

postgresql:
  enabled: false

externalDatabase:
  host: <host>
  port: <port>
  user: <user>
  database: <database>
  existingSecret: <secret-name>
  existingSecretPasswordKey: db-password
```

```shell
kubectl create namespace auth
```

```shell
helm upgrade keycloak bitnami/keycloak \
    --install \
    --version 7.1.17 \
    -n auth \
    --values values.yaml
```

## Realm

- Master Realm: 처음 시작할 때 생성되어 있는 realm으로 관리자 계정이 포함되어 있습니다. 다른 realm을 생성할 때만 사용하세요.
- Other Realm: 사용자와 필요한 응용 프로그램을 관리합니다.

### Realm Settings

#### Tokens

- https://www.keycloak.org/docs/latest/server_admin/#_timeouts

<br />

- SSO Session Idle: 활동이 없으면 세션이 만료되는 시간
- SSO Session Max: 최대 세션 시간
- Access Token Lifespan: JWT의 `ext-iat` 시간

## Authentication

- Authentication
  - Flows
    - Forms
      - Browser - Conditional OTP
        - REQUIRED
  - Required Actions
    - Configure OTP: enabled, default action
    - Update Password: enabled, default action
  - Password Policy
    - Minimum Length: 8
    - Lowercase Characters: 1
    - Digits: 1
    - Special Characters: 1
  - OTP Policy
    - OTP Type: Time Based
    - OTP Token Period: 30

## Client

## Email

### Gmail

- Google 계정 관리 -\> 보안 -\> Google에 로그인
  - 2 단계 인증
  - 앱 비밀번호
    - 앱 선택: 메일
    - 기기 선택: 기타
- Realm Settings
  - Email
    - Host: smtp.gmail.com
    - Port: 587
    - From: `<email>`
    - Enable StartTLS: on
    - Enable Authentication: on
      - Username: `<username>`
      - Password: `<password>` # 앱 비밀번호를 입력하세요.

## Test

- https://www.keycloak.org/docs/latest/server_development/#examples-of-using-curl

```shell
curl -k -X POST <keycloak-url>/auth/realms/<realm>/protocol/openid-connect/token \
    -H "Content-Type: application/x-www-form-urlencoded" \
    -d "client_id=<client-id>" \
    -d "client_secret=<client-secret>" \
    -d "scope=openid" \
    -d "grant_type=password" \
    -d "username=<user>" \
    -d "password=<password>" \
| jq '.'
```

- `-d "totp=<otp>"`

## Reference

- https://www.keycloak.org/docs/latest/server_admin/
