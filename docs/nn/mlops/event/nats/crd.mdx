---
id: crd
title: NATS CRD
sidebar_label: CRD
description: NATS CRD
keywords:
  - nats
  - crd
---

:::info
Stream, Consumer, Account의 name은 파일 경로로 사용되기 때문에 `[a-z0-9]*` 32자 이하로 만드는 것이 좋습니다. 버전 업데이트에 따라 이 제약사항이 사라질 수 있다고 합니다.
:::

## Stream

```shell
kubectl explain streams.spec
```

```yaml
apiVersion: jetstream.nats.io/v1beta2
kind: Stream
metadata:
  name: <resource-name>
  namespace: event
spec:
  name: <stream-name>
  subjects: # 이 Stream이 consume하는 subjects
    - <subject>

  storage: file # memory | file
  replicas: 3 # 1, 3, 5 ... 로 설정
  noAck: false

  retention: limits # limits | interest | workqueue
  discard: old # old | new
  # limits
  maxAge: "72h" # 00h00m00s | "", 메시지 최대 보관 기간
  maxMsgs: -1 # 최대 저장 메시지 수
  maxBytes: -1 # 최대 저장 용량

  maxMsgSize: -1 # 메시지 하나의 최대 크기, default: 1 MB
```

- `.spec.retention`
  - limits: max 옵션에 의해 정해진 값을 넘어간 메시지가 있을 때, `discard` 옵션에 따라 삭제
    - 다른 옵션으로 설정하더라도 항상 적용되는 제한입니다.
  - interest: 현재 정의된 Consumer가 모두 메시지를 받고 Ack를 보냈을 때 삭제
  - workqueue: 한 Consumer가 메시지를 받고 Ack를 보냈을 때 삭제, 한 Stream에 동일한 subject를 갖는 Consumer를 정의할 수 없음
- `.spec.discard`:
  - old: 가장 오래된 메시지를 삭제합니다.
  - new: 새로 들어오는 메시지를 거부합니다.

## Consumer

```shell
kubectl explain consumer.spec
```

### Common

- `.spec.ackPolicy`
  - none
  - all: 중간에 한 번이라도 Ack 응답을 받으면 이전에 받은 메시지는 Ack를 받은 것으로 간주
  - explicit: 모든 메시지에 Ack 응답(Pull에서만 사용 가능)
- `.spec.deliverPolicy`: Consumer를 생성했을 때 시작 위치
  - all
  - last
  - new
  - byStartSequence
  - byStartTime

### Push

```yaml
apiVersion: jetstream.nats.io/v1beta2
kind: Consumer
metadata:
  name: <resource-name>
  namespace: event
spec:
  streamName: <stream-name>
  durableName: <consumer-name> # 서버가 Consumer가 어디까지 소비했는 지 확인할 때 사용됨
  filterSubject: <subject>
  deliverSubject: <push-subject>
  # deliverGroup: <queue-group>
  deliverPolicy: all # all | last | new | byStartSequence | byStartTime
  # optStartSeq: 0
  # optStartTime: "2022-07-05T01:32:00+09:00"

  maxDeliver: 20 # Ack 정책으로 인해 재전송 될 때, 최대 재시도 횟수
  ackPolicy: explicit
  ackWait: 30s
  maxAckPending: 1000 # Ack 정책을 사용할 때, Ack를 받지 못한 메시지 수가 이 값을 넘어가면 일시 중지 됨
  rateLimitBps: -1

  # deliverPolicy에 따라 이전 메시지부터 메시지를 replay할 때
  # 원래 메시지를 받은 속도로 할지 아니면 가능한 빠른 속도로 할지 결정
  replayPolicy: instant # instant | original
```

### Pull

```yaml

```

## Reference

- https://github.com/nats-io/nack/blob/main/deploy/crds.yml
- https://docs.nats.io/using-nats/developer/develop_jetstream/model_deep_dive
