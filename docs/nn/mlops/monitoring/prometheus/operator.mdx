---
id: operator
title: prometheus-operator
sidebar_label: Operator
description: prometheus-operator
keywords:
  - prometheus-operator
---

## Installation

```shell
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
```

```shell
mkdir -p monitoring/prometheus-operator/helm
```

```shell
helm repo update prometheus-community \
&& helm search repo prometheus-community/kube-prometheus-stack -l | head -n 10
```

```shell
helm show values prometheus-community/kube-prometheus-stack \
    --version 35.6.2 \
    > monitoring/prometheus-operator/helm/values.yaml
```

```yaml title="monitoring/prometheus-operator/helm/values.yaml"
namespaceOverride: monitoring

commonLabels:
  cluster: "<cluster-name>"

defaultRules:
  # Chart가 제공하는 기본 alert and record rules의 집합
  # https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack/templates/prometheus/rules-1.14
  create: false

alertmanager:
  # -alertmanager 설치
  enabled: true

grafana:
  # -grafana 설치, 시각화 대시보드
  enabled: true

kubeApiServer:
  enabled: false

kubelet:
  # -kubelet 설치, cAdvisor: 실행중인 컨테이너의 정보
  enabled: true

kubeControllerManager:
  enabled: false

coreDns:
  enabled: false

kubeDns:
  enabled: false

kubeEtcd:
  enabled: false

kubeScheduler:
  enabled: false

kubeProxy:
  enabled: false

kubeStateMetrics:
  # -kube-state-metrics 설치, k8s Resource의 metadata, spec 등의 정보
  # https://github.com/kubernetes/kube-state-metrics/tree/master/docs
  enabled: true

nodeExporter:
  # -node-exporter 설치, Node의 Hardware, kernel 관련 정보
  # https://grafana.com/grafana/dashboards/1860
  enabled: true

prometheusOperator:
  # -operator 설치
  enabled: true
  tls:
    enabled: false

  admissionWebhooks:
    # PrometheusRules의 형식이 올바른지 확인해주는 기능인데 control plane이 webhook 서비스에
    # 접근할 수 있어야하는 문제가 있습니다.
    enabled: false

    patch:
      enabled: false

prometheus:
  # -prometheus 설치
  enabled: true

  prometheusSpec:
    # ruleSelector에 대한 추가 설정이 없으면 모든 rule이 적용됩니다.
    ruleSelectorNilUsesHelmValues: false

    # serviceMonitorSelector에 대한 설정이 없으면 모든 serviceMonitor가 적용됩니다.
    serviceMonitorSelectorNilUsesHelmValues: false

    # namespace에 prometheus: enabled 라는 라벨이 있으면 해당 ServiceMonitor를 수집합니다.
    serviceMonitorNamespaceSelector:
      matchLabels:
        prometheus: enabled

    # podMonitorSelector에 대한 설정이 없으면 모든 podMonitor가 적용됩니다.
    podMonitorSelectorNilUsesHelmValues: false

    # probeSelector에 대한 설정이 없으면 모든 probe가 적용됩니다.
    probeSelectorNilUsesHelmValues: false

    podMetadata:
      labels:
        sidecar.istio.io/inject: "true"

    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: gp2
          accessModes:
            - "ReadWriteOnce"
          resources:
            requests:
              storage: 30Gi
```

```shell
helm upgrade prometheus-operator prometheus-community/kube-prometheus-stack \
    --install \
    --version 35.6.2 \
    -n monitoring \
    -f monitoring/prometheus-operator/helm/values.yaml
```

```shell
kubectl label namespace monitoring prometheus=enabled
```

```shell
helm uninstall -n monitoring prometheus-operator
```

helm으로 삭제한 후 CRDs 삭제를 위해 아래 명령어를 실행해줍니다.

```shell
kubectl delete crd alertmanagerconfigs.monitoring.coreos.com
kubectl delete crd alertmanagers.monitoring.coreos.com
kubectl delete crd podmonitors.monitoring.coreos.com
kubectl delete crd probes.monitoring.coreos.com
kubectl delete crd prometheuses.monitoring.coreos.com
kubectl delete crd prometheusrules.monitoring.coreos.com
kubectl delete crd servicemonitors.monitoring.coreos.com
kubectl delete crd thanosrulers.monitoring.coreos.com
```

## Service

### Prometheus

```shell
kubectl port-forward -n monitoring service/prometheus-operator-prometheus 8003:9090
```

[http://localhost:8003](http://localhost:8003)

### Grafana

```shell
kubectl port-forward -n monitoring service/prometheus-operator-grafana 8004:80
```

[http://localhost:8004](http://localhost:8004)

#### Keycloak

- Client
  - `grafana` client 추가
    - Settings
      - Enabled: on
      - Client Protocol: openid-connect
      - Access Type: confidential
      - Root URL: `<grafana-url>`
      - Valid Redirect URIs: `<grafana-url>/login/generic_oauth`
    - Credentials
      - Client Authenticator: Client ID and Secret
      - Secret: `<grafana-client-secret>`
- Client Scopes
  - `groups` client scope 추가
    - Settings
      - Protocol: openid-connect
      - Include in Token Scope: on
    - Mappers
      - `groups` mapper 추가
        - Mapper Type: Group Membership
        - Token Claim Name: groups
        - Full group path: off
- Client
  - `grafana` client
    - Client Scopes
      - Default Client scopes
        - `groups` 추가
- Groups
  - `grafana-admin` 추가
  - `grafana-dev` 추가
- Users
  - 유저 추가
    - Email: `<email>`
    - Groups: `<group>`

```yaml title="monitoring/prometheus-operator/helm/values.yaml"
# https://github.com/grafana/helm-charts/blob/main/charts/grafana/values.yaml
# https://grafana.com/docs/grafana/latest/auth/generic-oauth/#generic-oauth-authentication
grafana:
  grafana.ini:
    server:
      root_url: <grafana-url>
    auth.generic_oauth:
      enabled: true
      name: Keycloak
      allow_sign_up: false
      client_id: grafana
      client_secret: <grafana-client-secret>
      scopes: openid profile email groups
      auth_url: <keycloak-url>/auth/realms/<realm>/protocol/openid-connect/auth
      token_url: <keycloak-url>/auth/realms/<realm>/protocol/openid-connect/token
      api_url: <keycloak-url>/auth/realms/<realm>/protocol/openid-connect/userinfo
      role_attribute_path: contains(groups[*], 'grafana-admin') && 'Admin' || contains(groups[*], 'grafana-dev') && 'Editor' || 'Viewer'
    database:
      type: mysql|postgres|sqlite3
      host: <host>:<port>
      name: <database>
      user: grafana
      password: <grafana-password>
    security:
      disable_initial_admin_creation: true
```

:::warning
초기에 생성된 admin 계정은 꼭 삭제해주세요.
:::

## Reference

- https://github.com/prometheus-community/helm-charts
