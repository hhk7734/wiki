---
id: nats
title: NATS
sidebar_label: NATS
description: NATS
keywords:
  - nats
---

## Installation

```shell
helm repo add nats https://nats-io.github.io/k8s/helm/charts
```

### NATS

```shell
helm repo update nats \
&& helm search repo nats/nats -l | head -n 10
```

```shell
helm show values nats/nats \
    --version 0.17.1 \
    > values.yaml
```

```yaml
nats:
  resources:
    requests:
      cpu: 1
      memory: 2Gi
    limits:
      cpu: 2
      memory: 2Gi

  jetstream:
    enabled: true

    memStorage:
      enabled: false
      size: 1Gi

    fileStorage:
      enabled: true
      storageDirectory: /data
      size: 10Gi
      accessModes:
        - ReadWriteOnce

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: nats
              app.kubernetes.io/instance: nats
          topologyKey: kubernetes.io/hostname
        weight: 100

cluster:
  enabled: true
  replicas: 3
```

```shell
helm upgrade nats nats/ntas \
    --install \
    --version 0.17.1 \
    -n workflow \
    -f values.yaml
```

### NACK

```shell
kubectl apply -f https://raw.githubusercontent.com/nats-io/nack/v0.6.1/deploy/crds.yml
```

```shell
helm repo update nats \
&& helm search repo nats/nack -l | head -n 10
```

```shell
helm show values nats/nack \
    --version 0.13.0 \
    > values.yaml
```

```yaml
jetstream:
  nats:
    url: nats://nats.workflow:4222
```

```shell
helm upgrade nack nats/nack \
    --install \
    --version 0.13.0 \
    -n workflow \
    -f values.yaml
```

## CRD

:::warning
Test 중
:::

### Stream

```shell
kubectl explain streams.spec
```

```yaml
apiVersion: jetstream.nats.io/v1beta2
kind: Stream
metadata:
  name: <resource-name>
  namespace: workflow
spec:
  name: <stream-name>
  subjects: # 이 Stream이 consume하는 subjects
    - <subject>

  storage: file # memory | file
  maxAge: "240h" # 00h00m00s | "", 메시지 최대 보관 기간
  replicas: 2

  retention: limits # limits | interest | workqueue
  discard: old # old | new, 제한된 값을 넘었을 때 삭제 순서
  maxBytes: -1 # 최대 저장 용량
  maxMsgs: -1 # 최대 저장 메시지 수
  maxMsgSize: -1 # 메시지 하나의 최대 크기
```

### Consumer

```shell
kubectl explain consumer.spec
```

```yaml
apiVersion: jetstream.nats.io/v1beta2
kind: Consumer
metadata:
  name: <resource-name>
  namespace: workflow
spec:
  durableName: <consumer-name> # 서버가 Consumer가 어디까지 소비했는지 확인하기 위한 이름
  streamName: <stream-name>
  filterSubject: <subject>
  deliverPolicy: all # all | last | new | byStartSequence | byStartTime
  # optStartSeq: 0
  # optStartTime: "2022-07-05T01:32:00+09:00"

  maxDeliver: 20 # Ack 정책으로 인해 재전송 될 때, 최대 재시도 횟수
  ackPolicy: explicit
  ackWait: 30s
  maxAckPending: 1000 # Ack 정책을 사용할 때, Ack를 받지 못한 메시지 수가 이 값을 넘어가면 일시 중지 됨
  rateLimitBps: -1

  # deliverPolicy에 따라 이전 메시지부터 메시지를 replay할 때
  # 원래 메시지를 받은 속도로 할지 아니면 가능한 빠른 속도로 할지 결정
  replayPolicy: instant # instant | original
```
