---
id: multi-cluster
title: Multi-cluster
sidebar_label: Multi-cluster
description: Multi-cluster
keywords:
  - multi-cluster
---

import useBaseUrl from "@docusaurus/useBaseUrl";

## Configure Trust

- https://istio.io/latest/docs/tasks/security/cert-management/plugin-ca-cert/

```shell
mkdir certs \
&& cd certs
```

```shell
wget https://raw.githubusercontent.com/istio/istio/master/tools/certs/common.mk \
&& wget https://raw.githubusercontent.com/istio/istio/master/tools/certs/Makefile.selfsigned.mk
```

```shell
make -f Makefile.selfsigned.mk root-ca
```

- `root-cert.pem`: 생성된 루트 인증서
- `root-key.pem`: 생성된 루트 키
- `root-ca.conf`: openssl루트 인증서를 생성하기 위한 구성
- `root-cert.csr`: 루트 인증서에 대해 생성된 CSR

```shell
export CLUSTER_NAME=<clusterName>
```

```shell
make -f Makefile.selfsigned.mk ${CLUSTER_NAME}-cacerts
```

:::info
`CLUSTER_NAME`이 CSR의 `localityName`으로 설정됩니다.
:::

클러스터 수 만큼 인증서를 생성해주세요.

- `ca-cert.pem`: 생성된 중간 인증서
- `ca-key.pem`: 생성된 중간 키
- `cert-chain.pem`: istiod에서 사용하는 생성된 인증서 체인
- `root-cert.pem`: 루트 인증서

```shell
kubectl create secret generic cacerts -n istio-system \
    --from-file=$CLUSTER_NAME/ca-cert.pem \
    --from-file=$CLUSTER_NAME/ca-key.pem \
    --from-file=$CLUSTER_NAME/cert-chain.pem \
    --from-file=$CLUSTER_NAME/root-cert.pem
```

## Multi-Primary on different networks

- https://istio.io/latest/docs/setup/install/multicluster/multi-primary_multi-network/

<center>
  <img src={useBaseUrl("img/mlops/mlops/istio/istio-multi-primary-diff.svg")} />
</center>

<center>
  <strong>Multiple primary clusters on separate networks</strong>
</center>
<br />

### Cross gateway

각 클러스터 별로 아래 과정을 동일하게 수행해주세요.

```shell
kubectl config use-context <context>
```

```shell
kubectl label namespace istio-system topology.istio.io/network=<network>
```

:::warning
`meshID`를 제외한 다른 값들은 클러스터별로 다른 값을 설정해주세요.
:::

```yaml title="istiod-values.yaml"
meshConfig:
  enablePrometheusMerge: true
  rootNamespace: istio-system
  trustDomain: "cluster.local"

global:
  meshID: <mesh-id> # 이 값은 공통으로 사용됩니다.
  multiCluster:
    enabled: true
    clusterName: <clusterName>
  network: <network>
```

```shell
helm upgrade istiod istio/istiod \
    --install \
    --version $ISTIO_VERSION \
    -n istio-system \
    -f istiod-values.yaml
```

```shell
helm show values istio/gateway \
    --version $ISTIO_VERSION \
    > cross-ingress-values.yaml
```

```yaml title="cross-ingress-values.yaml"
revision: <revision>

service:
  ports:
    - name: status-port
      port: 15021
      targetPort: 15021
      protocol: TCP
      nodePort: <node-port-1>
    - name: tls
      port: 15443
      targetPort: 15443
      protocol: TCP
      nodePort: <node-port-2>
    - name: tls-istiod
      port: 15012
      targetPort: 15012
      protocol: TCP
      nodePort: <node-port-3>
    - name: tls-webhook
      port: 15017
      targetPort: 15017
      protocol: TCP
      nodePort: <node-port-4>
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-proxy-protocol: "*"
    proxy.istio.io/config: '{"gatewayTopology" : { "numTrustedProxies": 2 } }'

autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 1
  targetCPUUtilizationPercentage: 80

labels:
  topology.istio.io/network: <network>

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - cross-ingress
          topologyKey: "kubernetes.io/hostname"
        weight: 50

networkGateway: <network>
```

```shell
helm upgrade cross-ingress istio/gateway \
    --install \
    --version $ISTIO_VERSION \
    -n istio-system \
    -f cross-ingress-values.yaml
```

```yaml title="network/istio/cross-gateway.yaml"
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: cross-gateway
  namespace: istio-system
spec:
  selector:
    istio: cross-ingress
  servers:
    - port:
        number: 15443
        name: tls
        protocol: TLS
      tls:
        mode: AUTO_PASSTHROUGH
      hosts:
        - "*.local"
```

```shell
kubectl apply -f network/istio/cross-gateway.yaml
```

### Endpoint Discovery

각 클러스터가 api-server에 접근할 수 있도록 설정해주세요.

```shell
istioctl x create-remote-secret \
  --context=<A-clusterContext> \
  --name=<A-clusterName> | \
  kubectl apply -f - --context=<B-clusterContext>
```

## Test

```shell
kubectl run tmp-shell --rm -it --image nicolaka/netshoot --labels sidecar.istio.io/inject="true" -- /bin/bash
```

## 운영 시 주의사항

- Resource의 labels에 `cluster: <cluster>`를 추가해서 클러스터 식별을 할 수 있게 만들면 좋습니다.
- Service name을 정할 때, 멀티 클러스터 에서 접근하는 경우와 각 클러스터에서만 접근하는 경우를 고려해서 정하는 게 좋습니다.
