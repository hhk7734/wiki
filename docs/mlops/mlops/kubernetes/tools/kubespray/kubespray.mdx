---
id: kubespray
title: Kubespray로 Kubernetes 클러스터 생성하기
sidebar_label: Kubespray
description: Kubespray로 Kubernetes 클러스터 생성하기
keywords:
  - kubespray
  - kubeadm
  - ansible
---

## 사전 작업

- 최소 필요 조건
  - 2 CPU
  - 2 GB memory
  - 모든 노드에 대한 고유한 호스트 이름, MAC 주소, prodcut_uuid
    - `ip link`
    - `sudo cat /sys/class/dmi/id/product_uuid`

## Inventory 생성

```shell
podman run --rm -it \
  -v <path>/inventory:/kubespray/inventory/new \
  quay.io/kubespray/kubespray:v2.24.0 \
  cp -rfp /kubespray/inventory/sample/. /kubespray/inventory/new
```

kubespray 레포지토리에 있는 `kubespray/inventory/sample` 디렉토리 내용을 `inventory/`로 복사합니다. 이후 설명에서 경로는 `inventory/`로 표시하겠습니다.

inventory 작성은 [Inventory](/docs/mlops/mlops/ansible/inventory)을 참고하시면 됩니다.

```yaml title="inventory/hosts.yaml"
all:
  hosts:
    <hostname>:
      ansible_host: <host> # ansible이 접근 가능한 주소
      ansible_port: <port> # ansible이 접근 가능한 포트
      ip: <ip> # Node IP
      access_ip: <ip>

kube_control_plane:
  hosts:
    <hostname>:

kube_node:
  hosts:
    <hostname>:

etcd:
  hosts:
    <hostname>:

bastion:
  hosts: {}

# Calico Route Reflector
calico_rr:
  hosts: {}

# 수정하지 마세요.
k8s_cluster:
  children:
    kube_control_plane:
    kube_node:
```

## 클러스터 생성

```shell
inventory/
├── group_vars/
│   ├── all/
│   │   ├── all.yml
│   │   └── ...
│   ├── k8s_cluster/
│   │   ├── addons.yml
│   │   ├── k8s-cluster.yml
│   │   └── ...
│   └── etcd.yml
├── patches/
└── hosts.yaml
```

- group_vars/
  - k8s_cluster/
    - k8s-cluster.yml: 클러스터의 기본 구성을 설정합니다.
      - `kube_oidc_*`: kube-apiserver에 OIDC 관련 설정을 추가합니다.
      - `kube_network_plugin: <cni|false>`
      - `kubeconfig_localhost: <true|false>`: kubeconfig 파일을 로컬에 생성할지 여부를 설정합니다.
    - addons.yml: metrics-server, metallb 등 클러스터에 추가할 애드온을 설정합니다.

```shell
podman run --rm -it \
  -v <path>/inventory:/kubespray/inventory \
  quay.io/kubespray/kubespray:v2.24.0 \
  ansible-playbook -i /kubespray/inventory \
  /kubespray/cluster.yml
```

## 노드 추가

`inventory/hosts.yaml`에 노드 정보를 추가합니다.

```shell
podman run --rm -it \
  -v <path>/inventory:/kubespray/inventory \
  quay.io/kubespray/kubespray:v2.24.0 \
  ansible-playbook -i /kubespray/inventory \
  /kubespray/scale.yml
```

## 노드 삭제

- `kubectl drain <node>`
  - DaemonSet을 확인하고 무시해도 되면 `--ignore-daemonsets` 옵션을 사용합니다.
  - emptyDir를 사용하는 Pod을 확인하고 무시해도 되면 `--delete-local-data` 옵션을 사용합니다.
  - 관리되지 않는 Pod을 확인하고 무시해도 되면 `--force` 옵션을 사용합니다.
- `kubectl delete node <node>`

```shell
podman run --rm -it \
  -v <path>/inventory:/kubespray/inventory \
  quay.io/kubespray/kubespray:v2.24.0 \
  ansible-playbook -i /kubespray/inventory \
  --extra-vars "node=<node1>,<node2>" \
  /kubespray/remove-node.yml
```

제거하려는 노드들에 SSH로 접근이 안되는 경우 `--extra-vars reset_nodes=false`를 추가하고, 일부 노드에만 접근이 안되는 경우 host 변수에 `reset_nodes=false`를 추가합니다.

제거된 후 `inventory/hosts.yaml`에서 노드 정보를 삭제합니다.

## 클러스터 삭제

```shell
podman run --rm -it \
  -v <path>/inventory:/kubespray/inventory \
  quay.io/kubespray/kubespray:v2.24.0 \
  ansible-playbook -i /kubespray/inventory \
  /kubespray/reset.yml
```
