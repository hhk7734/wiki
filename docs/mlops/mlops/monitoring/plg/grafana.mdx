---
id: grafana
title: Grafana
sidebar_label: Grafana
description: Grafana
keywords:
  - Grafana
---

## Installation

```shell
helm repo add grafana https://grafana.github.io/helm-charts
```

```shell
helm repo update grafana \
&& helm search repo grafana/grafana -l | head -n 10
```

```shell
helm show values grafana/grafana \
    --version 6.42.5 \
    > grafana-values.yaml
```

```yaml title="grafana-values.yaml"
extraLabels: {}

podLabels: {}

resources:
  limits:
    cpu: 500m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 1Gi

grafana.ini:
  # users, data sources, and dashboards 같은 설정을 저장합니다.
  database:
    type: mysql|postgres|sqlite
    host: <host>:<port>
    name: <database>
    user: grafana
    password: <grafana-password>
```

## Keycloak

- Client
  - `grafana` client 추가
    - Settings
      - Enabled: on
      - Client Protocol: openid-connect
      - Access Type: confidential
      - Root URL: `<grafana-url>`
      - Valid Redirect URIs: `<grafana-url>/login/generic_oauth`
    - Credentials
      - Client Authenticator: Client ID and Secret
      - Secret: `<grafana-client-secret>`
- Client Scopes
  - `groups` client scope 추가
    - Settings
      - Protocol: openid-connect
      - Include in Token Scope: on
    - Mappers
      - `groups` mapper 추가
        - Mapper Type: Group Membership
        - Token Claim Name: groups
        - Full group path: off
- Client
  - `grafana` client
    - Client Scopes
      - Default Client scopes
        - `groups` 추가
- Groups
  - `grafana-admin` 추가
  - `grafana-dev` 추가
- Users
  - 유저 추가
    - Email: `<email>`
    - Groups: `<group>`

```yaml title="grafana-values.yaml"
# https://grafana.com/docs/grafana/latest/setup-grafana/configure-security/configure-authentication/generic-oauth/
grafana.ini:
  server:
    root_url: <grafana-url>
  auth.generic_oauth:
    enabled: true
    name: Keycloak
    allow_sign_up: false
    client_id: grafana
    client_secret: <grafana-client-secret>
    scopes: openid profile email groups
    auth_url: <keycloak-url>/auth/realms/<realm>/protocol/openid-connect/auth
    token_url: <keycloak-url>/auth/realms/<realm>/protocol/openid-connect/token
    api_url: <keycloak-url>/auth/realms/<realm>/protocol/openid-connect/userinfo
    # grafana-admin, grafana-dev 그룹
    role_attribute_path: contains(groups[*], 'grafana-admin') && 'Admin' || contains(groups[*], 'grafana-dev') && 'Editor' || 'Viewer'
  security:
    disable_initial_admin_creation: true
```

:::warning
초기에 생성된 admin 계정은 꼭 삭제해주세요.
:::
