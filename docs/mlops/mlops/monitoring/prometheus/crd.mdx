---
id: crd
title: prometheus-operator CRD
sidebar_label: Operator CRD
description: prometheus-operator CRD
keywords:
  - prometheus-operator
  - CRD
---

import Image from "@theme/IdealImage";

<center>
  <Image
    img={require("@site/static/img/mlops/mlops/monitoring/prometheus-operator-architecture.png")}
    width={750}
  />
</center>
<center>
  <strong>Prometheus Operator Architecture</strong>
</center>

## Prometheus

### ServiceAccount

- https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/getting-started.md#enable-rbac-rules-for-prometheus-pods

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus
  namespace: monitoring

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus
rules:
  - apiGroups: [""]
    resources:
      - nodes
      - nodes/metrics
      - services
      - endpoints
      - pods
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources:
      - configmaps
    verbs: ["get"]
  - apiGroups:
      - networking.k8s.io
    resources:
      - ingresses
    verbs: ["get", "list", "watch"]
  - nonResourceURLs: ["/metrics"]
    verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus
subjects:
  - kind: ServiceAccount
    name: prometheus
    namespace: monitoring
```

### Prometheus

- https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#prometheus

spec에 맞는 prometheus StatefulSets을 생성합니다.

```yaml
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: prometheus
  namespace: monitoring
spec:
  serviceAccountName: prometheus

  podMonitorNamespaceSelector: {}
  podMonitorSelector: {}

  serviceMonitorNamespaceSelector:
    matchLabels:
      prometheus: enabled
  serviceMonitorSelector: {}

  retention: 10d

  podMetadata:
    labels:
      sidecar.istio.io/inject: "true"
  resources:
    requests:
      cpu: "100m"
      memory: 1500Mi
    limits:
      memory: 1500Mi
  storage:
    volumeClaimTemplate:
      spec:
        storageClassName: gp3
        accessModes:
          - "ReadWriteOnce"
        resources:
          requests:
            storage: 30Gi

  initContainers:
    - name: "prometheus-permission",
      image: "busybox",
      command: ["/bin/chmod", "-R", "777", "/prometheus"],
      volumeMounts:
        - name: "prometheus-prometheus-db",
          mountPath: "/prometheus",

  thanos:
    objectStorageConfig:
      - key: "objstore.yml",
        name: "thanos-objstore-secret",
```

- `kubectl get namespace -L prometheus` 명령어로 감시 대상 namespace를 확인할 수 있습니다.

:::info

Scrape 설정 추가를 아래와 같은 방법으로 직접 작성해 넣을 수 있습니다.

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: additional-scrape-configs
  namespace: monitoring
stringData:
  prometheus-additional.yaml: |
    - job_name: 'prometheus-other-cluster-1'
      scheme: http
      scrape_interval: 23s
      scrape_timeout: 23s
      honor_labels: true
      metrics_path: '/federate'

      params:
        'match[]':
          - '{job=~".+", job!="kublet"}'

      static_configs:
        - targets:
          - 'prometheus-eks-2.monitoring:9090'

    - job_name: 'prometheus-other-cluster-2'
      scheme: http
      scrape_interval: 21s
      scrape_timeout: 21s
      honor_labels: true
      metrics_path: '/federate'

      params:
        'match[]':
          - '{job="kublet"}'

      static_configs:
        - targets:
          - 'prometheus-eks-2.monitoring:9090'
```

```yaml
spec:
  additionalScrapeConfigs:
    name: additional-scrape-configs
    key: prometheus-additional.yaml
```

:::

### Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: monitoring
spec:
  type: ClusterIP
  ports:
    - name: http-web
      port: 9090
      protocol: TCP
      target_port: 9090
  selector:
    prometheus: prometheus
```

## ServiceMonitor

- https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#servicemonitor

수집하고 싶은 `Service` 정보 등록

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: istiod
  namespace: monitoring
  labels:
    app: istiod
spec:
  # Service.metadata.labels에 매칭되는 label의 키값을 job의 값으로 사용합니다.
  # 선언하지 않으면 Service.metadata.name의 값을 사용합니다.
  jobLabel: istio
  selector:
    matchExpressions: # labels에 `istio: pilot`이 있는 Service를 감시합니다.
      - { key: istio, operator: In, values: [pilot] }
  namespaceSelector: # Service namespace selector
    any: true
    # matchNames:
    #   - istio-system
  endpoints:
    - port: http-monitoring # Service에서 prometheus를 위해 노출한 port
      path: /metrics # 기본값: /metrics
      interval: 15s
```

## PodMonitor

- https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#podmonitor

수집하고 싶은 `Pod` 정보 등록

:::info
Service가 없는 Pod나, Service가 있지만 그 중 특정 Label이 있는 Pod를 모니터링할 때만 사용하고, 그 외에는 ServiceMonitor를 사용하시는 것이 좋습니다.
:::

```yaml
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: envoy-stats
  namespace: monitoring
  labels:
    app: istio-proxy
spec:
  jobLabel: envoy-stats
  selector:
    matchExpressions: # labels에 istio-prometheus-ignore 가 없는 모든 Pod를 감시합니다.
      - { key: istio-prometheus-ignore, operator: DoesNotExist }
  namespaceSelector:
    any: true
  podMetricsEndpoints:
    - path: /stats/prometheus
      interval: 15s
      relabelings:
        - action: keep
          sourceLabels: [__meta_kubernetes_pod_container_name]
          regex: "istio-proxy"
        - action: keep
          sourceLabels:
            [__meta_kubernetes_pod_annotationpresent_prometheus_io_scrape]
        - sourceLabels:
            [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
          action: replace
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: $1:$2
          targetLabel: __address__
        - action: labeldrop
          regex: "__meta_kubernetes_pod_label_(.+)"
        - sourceLabels: [__meta_kubernetes_namespace]
          action: replace
          targetLabel: namespace
        - sourceLabels: [__meta_kubernetes_pod_name]
          action: replace
          targetLabel: pod_name
```

## 설정

### relabel_configs

- https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config

스크랩하기 전에 서비스 디스커버리 등에 의해 설정된 레이블을 조작하는 설정입니다.

```yaml
spec:
  endpoints:
    - relabelings:
        sourceLabels:
          - <sourceLabel>
        action: replace # 기본값: replace
        # separator: ";" # 기본값: ;, 값이 여러개일 경우 구분값
        targetLabel: <targetLabel>
        # modulus: <int>
        regex: (.*) # 기본값: (.+)
        replacement: $1 # 기본값: $1
```

- `actions`
  - `replace`: `sourceLabels`중 값이 `regex`에 맞는 레이블을 찾습니다. 찾은 레이블을 `targetLabel`로 변경하고 값은 `replacement`로 변경합니다.
  - `keep`: `sourceLabels`중 `regex`와 값이 매칭되는 레이블만 유지합니다
  - `drop`: `sourceLabels`중 `regex`와 값이 매칭되는 레이블을 제거합니다
  - `lowercase`
  - `uppercase`
  - `hashmod`
  - `labelmap`
  - `labeldrop`
  - `labelkeep`

:::info
`__`로 시작하는 레이블은 relabel 과정이 모두 끝난 후에는 제거됩니다.
:::

### metric_relabel_configs

- https://prometheus.io/docs/prometheus/latest/configuration/configuration/#metric_relabel_configs

스크랩한 후 저장하기 전에 레이블을 조작하는 설정입니다.

## Reference

- https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/getting-started.md
- https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md

```

```
