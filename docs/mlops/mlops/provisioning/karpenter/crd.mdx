---
id: crd
title: Karpenter CRD
sidebar_label: CRD
description: Karpenter CRD
keywords:
  - karpenter
  - crd
---

## Provisioner

- https://karpenter.sh/docs/concepts/provisioners/

Provisioner는 **Provisioner에 명시된 제약사항**과 **Workload에 명시된 제약사항 중 처리 가능한 제약사항**을 고려하여 프로비저닝을 수행합니다. 옵션이 다양한 만큼 여러 제약사항의 조합을 만들 수 있도록 하여 유언성을 제공합니다.

또한 kube-scheduler나 Node가 준비 상태가 되기 전에 Pod가 배치되기 위한 작업을 미리 수행해서 노드 시작 대기 시간을 줄여 줍니다.

:::warning
Node는 Provisioner가 소유합니다. 따라서 Provisioner를 삭제하면 소유하고 있는 Node들도 삭제됩니다.
:::

```yaml
apiVersion: karpenter.sh/v1alpha5
kind: Provisioner
metadata:
  name: <name>
```

```shell
kubectl explain provisioner.spec
```

### providerRef

```yaml
spec:
  providerRef:
    name: <NodeTemplateName>
```

### kubeletConfiguration

- https://karpenter.sh/docs/concepts/provisioners/#speckubeletconfiguration

```yaml
spec:
  kubeletConfiguration:
    clusterDNS:
      - '<ip|url>'
    containerRuntime: containerd # dockerd | containerd
    maxPods: 100
    podsPerCore: 10
```

### labels

```yaml
spec:
  # Node에 추가될 labels입니다.
  labels:
    <key>: <value>
```

`nodeAffinity`와 `nodeAntiAffinity`에 사용됩니다.

### limits

```yaml
spec:
  limits:
    resources:
      # 관리하는 리소스의 총 합이 아래 설정 값을 넘어가면 더이상 노드를 생성하지 않음
      # cpu: "10" 으로 설정되더라도 72 코어 인스턴스가 생성될 수 있음
      cpu: <DecimalSI> # m | "" | k | M | G | T | P | E
      memory: <BinarySI> # Ki | Mi | Gi | Ti | Pi | Ei
```

### requirements

- https://karpenter.sh/docs/concepts/provisioners/#specrequirements

<br />

- [잘 알려진 label](https://kubernetes.io/docs/reference/labels-annotations-taints/)을 key로 하는 조건을 설정 할 수 있습니다

```yaml
spec:
  requirements:
    - key: <string>
      operator: <In|NotIn>
      values:
        - <string>
```

```yaml title="default"
spec:
  requirements:
    - key: karpenter.k8s.aws/instance-category
      operator: In
      values: ['c', 'm', 'r']
    - key: karpenter.k8s.aws/instance-generation
      operator: Gt
      values: ['2']
    - key: kubernetes.io/arch
      operator: In
      values: ['amd64']
    - key: kubernetes.io/os
      operator: In
      values: ['linux']
    - key: karpenter.sh/capacity-type
      operator: In
      values: ['on-demand']
```

- `key`, `values`
  - [Well-Knwon Label](/docs/mlops/mlops/provisioning/karpenter/scheduling#well-knwon-labels)
- `operator`
  - `In`
  - `NotIn`
  - `Exists`
  - `DoesNotExist`
  - `Gt`: 정수값이 주어졌을 때만 사용 가능, 설정한 값보다 큰 경우 매칭됩니다.
  - `Lt`: 정수값이 주어졌을 때만 사용 가능, 설정한 값보다 작은 경우 매칭됩니다.

:::warning

- `values`에는 숫자도 `"`로 감싸서 문자열로 입력해야 합니다.
- 하나도 선언을 안하면 기본값으로 설정되므로 유의해야합니다.

:::

### taints

```yaml
spec:
  taints:
    - key: <string>
      value: <string>
      effect: <NoSchedule|PreferNoSchedule|NoExecute>
```

### ttlSeconds\*

Karpenter는 각 Node에 `Finalizer`를 설정하여 Node 삭제 프로세스를 개선해줍니다.

```yaml
spec:
  # ttlSecondsAfterEmpty를 설정하면 Daemonset을 제외한 Pod가 없을 때,
  # 설정 된 시간내에 새로운 Pod이 스케줄 되지 않으면 Node를 정리합니다.
  # In seconds
  ttlSecondsAfterEmpty: <int>
  # ttlSecondsUntilExpired를 설정하면 Node가 시작된 후, 설정 된 시간이 지났을 때,
  # Node를 정리합니다.
  # In seconds
  ttlSecondsUntilExpired: <int>
```

`kubectl delete node <node>` 또는 `kubectl delete node -l <key>[=<value>]`로 Node를 제거할 때에도 Karpenter가 관리하는 Node는 미리 Finalizer를 설정해놨기 때문에 Node 삭제에 의해 생길 수 있는 문제를 최소화 해줍니다.

### consolidation

- https://karpenter.sh/docs/concepts/deprovisioning/#consolidation

```yaml
spec:
  # 통합 할 수 있는 노드를 통합하고, 불필요한 노드를 정리합니다
  # ttlSecondsAfterEmpty와 같이 설정할 수 없습니다
  consolidation:
    enabled: true
```

## Machine

```shell
kubectl explain machine.spec
```

```yaml
apiVersion: karpenter.sh/v1alpha5
kind: Machine
metadata:
  name: <name>
```

## AWSNodeTemplate

- https://karpenter.sh/docs/concepts/node-templates/

```shell
kubectl explain awsnodetemplate.spec
```

```yaml
apiVersion: karpenter.k8s.aws/v1alpha1
kind: AWSNodeTemplate
metadata:
  name: <name>
spec:
  # subnet의 AWS 태그를 설정하면 됩니다. `*`(와일드카드), `,`(구분자)를 사용할 수 있습니다
  subnetSelector:
    <key>: <value>
    # Name: subnet-xxxx
    # kubernetes.io/cluster/<cluster_name>: '*'
  securityGroupSelector:
    <key>: <value>
    # Name: sg-xxxx
    # kubernetes.io/cluster/<cluster_name>: '*'
  # 설치했을 때 설정한 defaultInstanceProfile 이 기본값입니다
  instanceProfile: <instanceProfile>
  tags:
    <key>: <value>
    # 아래 태그가 생성된 EC2 인스턴스에 기본으로 적용됩니다
    # Name: karpenter.sh/cluster/<cluster_name>/provisioner/<provisioner_name>
    # karpenter.sh/provisioner-name: <name>
    # kubernetes.io/cluster/<cluster_name>: owned
  metadataOptions:
    <key>: <value>
    # 설정하지 않으면 아래 값이 설정 됩니다
    # httpEndpoint: enabled
    # httpProtocolIPv6: disabled
    # httpPutResponseHopLimit: 2
    # httpTokens: required
  blockDeviceMappings:
    - deviceName: /dev/xvda
      ebs:
        volumeType: gp3
        volumeSize: 50Gi
        encrypted: true
        deleteOnTermination: true
  userData: <userData>
```
