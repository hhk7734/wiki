---
id: eks
title: EKS
sidebar_label: EKS
description: EKS
keywords:
  - EKS
---

## Create

### VPC & Subnet

`kubernetes.io/cluster/<cluster-name>: <shared|owned>` 태그를 추가해주세요.

### Role

```typescript
function createEKSRole(): aws.iam.Role {
  const name = "eks-role";
  return new aws.iam.Role(name, {
    namePrefix: `${name}-`,
    assumeRolePolicy: {
      Statement: [
        {
          Action: "sts:AssumeRole",
          Effect: "Allow",
          Principal: {
            Service: "eks.amazonaws.com",
          },
        },
      ],
      Version: "2012-10-17",
    },
    tags: {
      Name: name,
      "loliot.net/cluster": variable.clusterName,
      "loliot.net/stack": variable.stackName,
    },
  });
}

const role = createEKSRole();

const clusterPolicyARNs = {
  "0": "arn:aws:iam::aws:policy/AmazonEKSClusterPolicy",
};

const rpas = Object.entries(clusterPolicyARNs).map(
  ([i, arn]) =>
    new aws.iam.RolePolicyAttachment(
      `eks-rpa-${i}`,
      {
        policyArn: arn,
        role: role.name,
      },
      { dependsOn: [role] }
    )
);
```

### Cluster

```typescript
function createEKS(): aws.eks.Cluster {
  const name = "eks";
  return new aws.eks.Cluster(
    name,
    {
      name: name,
      version: "1.21",
      roleArn: role.arn,
      vpcConfig: {
        endpointPublicAccess: true,
        subnetIds: [
          vpc.publicSubnet0.id,
          vpc.privateSubnet0.id,
          vpc.privateSubnet1.id,
        ],
      },
      kubernetesNetworkConfig: { serviceIpv4Cidr: "10.96.0.0/16" },
      tags: {
        Name: name,
        "loliot.net/cluster": variable.clusterName,
        "loliot.net/stack": variable.stackName,
      },
    },
    { dependsOn: [...rpas] }
  );
}

const eks = createEKS();
```

```shell
aws eks list-clusters
```

```shell
aws eks update-kubeconfig \
    --name <cluster-name> \
    --kubeconfig ~/.kube/<cluster-name>_config
```

```shell
export KUBECONFIG=<config-path>[:<config-path>]
```

### OIDC

- EKS - 클러스터 - 구성 - 세부 정보 - OpenID Connect 공급자 URL
- IAM - 액세스 관리(Access management) - 자격 증명 공급자(Identity Providers) - 공급자 추가

```typescript
function createOIDCProvider(): aws.iam.OpenIdConnectProvider {
  const name = "eks-oidc-provider";
  return new aws.iam.OpenIdConnectProvider(
    name,
    {
      url: eks.identities[0].oidcs[0].issuer,
      clientIdLists: ["sts.amazonaws.com"],
      thumbprintLists: ["***"],
      tags: {
        Name: name,
        "loliot.net/cluster": variable.clusterName,
        "loliot.net/stack": variable.stackName,
      },
    },
    { dependsOn: [eks] }
  );
}

export const oidcProvider = createOIDCProvider();
```

### VPC CNI increases pods per node limits

```shell
kubectl set env daemonset aws-node -n kube-system \
    ENABLE_PREFIX_DELEGATION=true
```

```shell
kubectl set env daemonset aws-node -n kube-system \
    WARM_PREFIX_TARGET=1
```

:::warning
`pulumi`를 사용할 때, NodeGroup 생성 전에 이 작업을 진행해야 UserData의 `--kubelet-extra-args`가 자동으로 설정됩니다.
:::

### NodeGroup

```python
# NodeGroup

name = "eks-ng-role"
ng_role = aws.iam.Role(
    name,
    name_prefix=name,
    assume_role_policy=json.dumps(
        {
            "Statement": [
                {
                    "Action": "sts:AssumeRole",
                    "Effect": "Allow",
                    "Principal": {"Service": "ec2.amazonaws.com"},
                }
            ],
            "Version": "2012-10-17",
        }
    ),
    opts=pulumi.ResourceOptions(parent=cluster),
    tags={
        "Name": name,
        "Stack": variable.stack_name,
        "Github": variable.github,
    },
)

node_policy_arns = {
    "0": "arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy",
    "1": "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly",
    "2": "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy",
}

ng_rpas = []
for i, arn in node_policy_arns.items():
    ng_rpas.append(
        aws.iam.RolePolicyAttachment(
            f"eks-ng-rpa-{i}",
            policy_arn=arn,
            role=ng_role.name,
            opts=pulumi.ResourceOptions(parent=ng_role),
        )
    )

name = "eks-ng-profile"
default_ng_profile = aws.iam.InstanceProfile(
    name,
    name_prefix=name,
    role=ng_role.name,
    opts=pulumi.ResourceOptions(parent=ng_role),
    tags={
        "Name": name,
        "Stack": variable.stack_name,
        "Github": variable.github,
    },
)

name = "eks-ng"
ng = aws.eks.NodeGroup(
    name,
    node_group_name=name,
    cluster_name=cluster.name,
    node_role_arn=ng_role.arn,
    instance_types=["m6a.xlarge"],
    disk_size=50,
    scaling_config=aws.eks.NodeGroupScalingConfigArgs(
        min_size=1,
        desired_size=1,
        max_size=1,
    ),
    subnet_ids=[vpc.public_subnet["0"].id],
    remote_access=aws.eks.NodeGroupRemoteAccessArgs(
        ec2_ssh_key=user.master_key.key_name,
    ),
    labels={
        "eks-ng": "true",
    },
    taints=[
        aws.eks.NodeGroupTaintArgs(
            key="eks-ng",
            value="true",
            effect="NO_SCHEDULE",
        ),
    ],
    opts=pulumi.ResourceOptions(depends_on=[cluster, *ng_rpas], parent=cluster),
    tags={
        "Name": name,
        "Stack": variable.stack_name,
        "Github": variable.github,
    },
)
```

## Reference

- [https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/getting-started-console.html](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/getting-started-console.html)
- [https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/enable-iam-roles-for-service-accounts.html](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/enable-iam-roles-for-service-accounts.html)
- [https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-increase-ip-addresses.html](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-increase-ip-addresses.html)
- [https://aws.amazon.com/ko/blogs/containers/amazon-vpc-cni-increases-pods-per-node-limits/](https://aws.amazon.com/ko/blogs/containers/amazon-vpc-cni-increases-pods-per-node-limits/)
